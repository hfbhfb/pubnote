---
title: nginx100讲第2讲开始
date: 2022-05-08 07:51:50
permalink: /pages/61b22d/
categories:
  - 运维
  - nginx插件100讲
tags:
  - 
---


## 02 Nginx的三个主要应用场景
- **静态资源服务**
  - **通过本地文件系统提供**
- **反向代理服务**
  - **Nginx的强大功能**
  - **缓存**
  - **负载均衡**
- API服务
  - **OpenResty**
  - **Mysql**

## 03 为什么会出现?
- **互联网的数据量快速增长**
- **CPU性能跟不上现实的摩尔定律**
- **低效的Apache**


## 04 Nginx优点
- **高并发 高性能**
  - **32核64G 轻松达到数千万并发连接**
  - **简单静态资源请求 100万rps**
- **可扩展性好**
  - **模块化设计**
  - **模块化设计非常稳定,三方模块生态圈丰富**
    - **甚至出现了四方模块圈 OpenResty**
- **高可靠性** **边缘节点**
  - **持续运行可以down机时间一年只能以秒计算** 
   - 1个9：(1-90%)*365=36.5天
   - 2个9：(1-99%)*365=3.65天
   - 3个9：(1-99.9%)*365*24=8.76小时
   - 4个9：(1-99.99%)*365*24=0.876小时=52.6分钟
   - 5个9：(1-99.999%)*365*24*60=5.26分钟
   - 6个9：(1-99.9999%)*365*24*60*60=31秒
- **热布署**
  - **不停止服务的情况下升级Nginx**
  - **kill掉进程,Linux内核会往对端服务器Tcp连接发送RESET数据包**
    - **数百万并发连接**
    - **影响面大,所以有需求让服务器稳定**
- **BSD许可证**


## 05 Nginx组成
- **Nginx二进制可执行文件**
  - 客模块定义编译
- **Nginx.conf配置文件**
  - 控制Nginx的行为
- **access.log访问日志**
- **error.log错误日志**

## 06 Nginx版本发布情况
- **nginx-1.15.5**  `mainline`
  - **Change** `发布日志`
    - https://nginx.org/en/download.html
- **nginx-1.14.0**  `stable`
- **版本情况**
  - **feature**
    - 功能
  - **bugfix**
    - bug
  - **change**
    - 重构
- **2015年新功能stream四层反向代理**

## 07 如何选择Nginx发行版
- 免费版的 Nginx
- 收费版的 Nginx
- 免费版的 OpenResty **应用场景:主攻Web防火墙**
  - Lua语言 **非阻塞** **事件框架** 
    - **高性能** **开发效率提升**
- 收费版的 OpenResty
- Tengine是阿里版的Nginx,不随主干升级


## 08 编译自己的Nginx
- **为什么要自己编译**
  - 官方版本apt,yum的包有些模块不会被编译
  - **第三方模块,Nginx生态圈**
- 步骤
  - **下载**
  - **介绍目录**
  - **Configure**
  - **中间文件介绍**
  - **编译**
  - **安装**

## configure 中间文件
- ./configure --help
  - **查看代码有哪些模块**
- --with-stream  **默认没有这个模块,你要这个模块的话,编译带上**
- --without-stream_upstream_least_conn_module **默认带这个模块,你不要在config去掉**

## 09 Nginx 配置文件
- **Nginx二进制文件中已经指定它包含了哪些模块**
  - **但每一个模块都会提供独一无二的配置语法**
- **所有语法都遵守相同的语法规则**
  - **指令** **指令块**
  - **指令以;分号结尾** **指令与参数以空格分隔**
  - **指令块以 {}包含**
  - **指令块可以有名字 也可以没有名字 由指代指令块的Nginx模块决定的(一个或多个参数或者没有参数)**
  - **include语句允许组合多个配置文件**
  - **#符号加注释**
  - **$符号使用参数** `$binary_remote_addr` `$host` `$uri` `$is_args` `$args`
  - **部分指令的参数支持正则表达式**
  - **时间的单位** 
    - **ms** milliseconds
    - **d** days
    - **s** seconds
    - **w** weeks
    - **m** minutes
    - **M** months,30days
    - **h** hours
    - **y** years,365days
  - **空间的单位**
    - **k**
    - **m**
    - **g**
  - **http框架模块中** `所有指令都是由http模块去解析指行`
    - **http**
    - **server**
      - **一个域名或者一组域名**
    - **upstream**
      - `表示上游服务`
    - **location**
      - **url表达式**


## 10 Nginx命令行
- **示例 : nginx -s reload**
- **使用指定的配置文件 -e**
- **指定运行目录 -p**
- **测试配置文件是否有语法错误 -t**
- **发送信号 -s**
- **版本信息或者编译信息 -v -V**

## 命令行演示
- **重载配置文件**
  - ./objs/nginx -p /Users/hfb/projects/c-c++/nginx-1.20.2/ -s reload
- **热布署** **版本升级**
  - **把二进制文件备份**
  - **把编译好的新版本二进制拷贝到原来的地址**
  - **kill -USR2 13195?**
  - **kill -WINCH 13195?**
  - **版本回退** **再拉起老版本**
    -   
- **日志切割**
  - **把文件移动换一个名**
  - ./objs/nginx -p /Users/hfb/projects/c-c++/nginx-1.20.2/ -s reopen
  - **crontab -l** **视频中有一个脚本,定期把日志切割**
    - **kill -USR1 $(cat /usr/local/openresty/nginx/logs/nginx.pid)**













