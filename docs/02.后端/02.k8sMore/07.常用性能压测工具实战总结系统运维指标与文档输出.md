---
title: 常用性能压测工具实战总结系统运维指标与文档输出
date: 2022-04-18 16:52:13
permalink: /pages/8066d6/
categories:
  - 后端
  - k8sMore
tags:
  - 
---


## 压测背景与现状
  * #### 以前
    * 未出社会之前经常用AB工具来压测自己的 nginx 欢迎页面，看着服务器的资源从20%到100%，发现原来一个开源的工具都可以把一台4C8G的虚拟机压爆满，然后就陷入沉思，低成本的压测都可以造成一台虚拟机的资源满负载，而且还是个静态页面，那如果发生在企业身上会如何？造成的损失远远高于压测方，后果不敢想象。
  * #### 现在
    * 我承认以前太天真了，既然有压测方，那肯定有防御方，遇到恶意压测他人网站的，直接通过各种全家桶拉黑、屏蔽掉就好了。那对于现在企业来说，各人觉得最大的价值就是探测资源性能、资源容量合理规划、增强业务稳定SLA、减少事故发生，这个对于测试还是运维来说都是天大的好事，也是价值的体现 
  * #### 未来
    * 压测的普适性，对企业带来的价值不止探测资源性能、资源容量合理规划，还有技术架构升级验证、业务系统上线测试、业务峰值稳定性测试等等，`通过压测清楚资源的能力`，降低盲目预估的风险，`提高服务的可用性和稳定性`。


## 1.工具说明
  * AB：ApacheBench 是 Apache服务器自带的一个web压力测试工具，简称ab
  * Jmeter：Apache JMeter是Apache组织开发的基于Java的压力测试工具

## 3.压测标准
  * #### 压力测试(Stress Testing)
    * 也称之为强度测试，测试一个系统的最大抗压能力，在强负载(大数据、高并发)的情况下，测试系统所能承受的最大压力，预估系统的瓶颈
  * #### 并发测试(Concurrency Testing)
    * 通过模拟很多用户同一时刻访问系统或对系统某一个功能进行操作，来测试系统的性能，从中发现问题(并发读写、线程控制、资源争抢)
  * #### 耐久性测试(Configuration Testing)
    * 通过对系统在大负荷的条件下长时间运行，测试系统、机器的长时间运行下的状况,从中发现问题(内存泄漏、数据库连接池不释放、资源不回收)


## 3.1 交易响应时间
  * 响应时间指用户从客户端发起一个请求开始，到客户端接收到从服务器端返回的响应结束，整个过程所耗费的时间。在性能检测中一般以压力发起端至被压测服务器返回处理结果的时间为计量，单位一般为秒或毫秒。平均响应时间指系统稳定运行时间段内，同一交易的平均响应时间。一般而言，交易响应时间均指平均响应时间。 平均响应时间指标值应根据不同的交易分别设定，一般情况下，分为复杂交易响应时间、简单交易响应时间、特殊交易响应时间。其中，特殊交易响应时间的设定必须明确该交易在响应时间方面的特殊性。
  * #### Response Time: 简称RT
    * 不同行业不同业务可接受的响应时间是不同的，一般情况，对于在线实时交易：
    * 互联网企业：500毫秒以下，例如淘宝业务10毫秒左右。
    * 金融企业：1秒以下为佳，部分复杂业务3秒以下。
    * 保险企业：3秒以下为佳。
    * 制造业：5秒以下为佳。
  * #### 对于批量交易：
    * 时间窗口：即整个压测过程的时间，不同数据量则时间不一样，例如双11和99大促，数据量级不一样则时间窗口不同。大数据量的情况下，2小时内可完成压测。

## 3.2 系统处理能力
  * #### 一般情况下，用以下指标来度量：
    * HPS（Hits Per Second） ：每秒点击次数，单位是次/秒。
    * TPS（Transaction per Second）：系统每秒处理交易数，单位是笔/秒。
    * QPS（Query per Second）：系统每秒处理查询次数，单位是次/秒。 对于互联网业务中，如果某些业务有且仅有一个请求连接，那么TPS=QPS=HPS，一般情况下用TPS来衡量整个业务流程，用QPS来衡量接口查询次数，用HPS来表示对服务器单击请求。

  * #### 参考标准数据
    * 无论TPS、QPS、HPS，此指标是衡量系统处理能力非常重要的指标，越大越好，根据经验，一般情况下：
    * 金融行业：1000 TPS  ~~50000 TPS，不包括互联网化的活动。~~
    * 保险行业：~~100 TPS~~ 100000 TPS，不包括互联网化的活动。
    * 制造行业：10 TPS ~~5000 TPS。~~
    * 互联网电子商务：~~10000 TPS~~ 1000000 TPS。
    * 互联网中型网站：1000 TPS ~~50000 TPS。~~
    * 互联网小型网站：~~500 TPS~~ 10000 TPS。

## 3.3 并发用户
  * 并发用户数指在同一时刻内，登录系统并进行业务操作的用户数量。 并发用户数对于长连接系统来说最大并发用户数即是系统的并发接入能力。对于短连接系统而言最大并发用户数并不等于系统的并发接入能力，而是与系统架构、系统处理能力等各种情况相关。例如系统吞吐能力很强，加上短连接一般都有连接复用，往往并发用户数大于系统的并发接入连接数。所以对于大部分短连接类型的系统，吞吐量模式（RPS模式，Request Per Second）比较适合，也是阿里的最佳实践，PTS支持RPS模式的压测，吞吐量的压测构建和衡量一步到位。 在测试中，采用虚拟用户来模拟现实中用户进行业务操作。
  * #### 标准
    * 一般情况下，性能测试是将系统处理能力容量测出来，而不是测试并发用户数，除了服务器长连接可能影响并发用户数外，系统处理能力不受并发用户数影响，可以用最小的用户数将系统处理能力容量测试出来，也可以用更多的用户将系统处理能力容量测试出来。
  * Virtual User：简称VU


## 3.4 错误率
  * 错误率指系统在负载情况下，失败交易的概率。错误率＝（失败交易数/交易总数）×100%。稳定性较好的系统，其错误率应该由超时引起，即为超时率。
  * #### 标准
    * 不同系统对错误率的要求不同，但一般不超出千分之六，即成功率不低于99.4%。


## 3.5 CPU
  * CPU指标主要指的CPU使用率、利用率，包括用户态（user）、系统态（sys）、等待态（wait）、空闲态（idle）。CPU使用率、利用率要低于业界警戒值范围之内，即小于或者等于75%、CPU sys%小于或者等于30%，CPU wait%小于或者等于5%。单核CPU也需遵循上述指标要求。CPU Load要小于CPU核数。
  * #### 标准
    * CPU指标主要指的CPU使用率、利用率，包括用户态（user）、系统态（sys）、等待态（wait）、空闲态（idle）。CPU使用率、利用率要低于业界警戒值范围之内，即小于或者等于75%、CPU sys%小于或者等于30%，CPU wait%小于或者等于5%。单核CPU也需遵循上述指标要求。CPU Load要小于CPU核数。

## 3.6 Memory
  * #### 标准
    * 现代的操作系统为了最大利用内存，在内存中存放了缓存，因此内存利用率100%并不代表内存有瓶颈，衡量系统内有瓶颈主要靠SWAP（与虚拟内存交换）交换空间利用率，一般情况下，SWAP交换空间利用率要低于70%，太多的交换将会引起系统性能低下。

## 3.7 磁盘吞吐量
  * #### 标准
    * 磁盘指标主要有每秒读写多少兆，磁盘繁忙率，磁盘队列数，平均服务时间，平均等待时间，空间利用率。其中磁盘繁忙率是直接反映磁盘是否有瓶颈的重要依据，一般情况下，磁盘繁忙率要低于70%。

## 3.8 网络吞吐量
  * #### 标准
    * 网络吞吐量指标主要有每秒有多少兆流量进出，一般情况下不能超过设备或链路最大传输能力的70%。


## 3.9 内核参数
  * 操作系统内核参数主要包括信号量、进程、文件句柄，一般不要超过设置的参数值即可


## 中间件 数据库指标
  * #### 标准
    * SQL耗时越小越好，一般情况下微秒级别。
    * 命中率越高越好，一般情况下不能低于95%。
    * 锁等待次数越低越好，等待时间越短越好。


## 中间件 前端指标
  * OnLoad事件时间 
    * 浏览器触发onLoad事件的时间，当原始文档和所有引用的内容完全下载后才会触发这个事件
  * DNS时间 
    * DNS查找时间
  * 请求数量
    * 从网站下载资源时所有网络请求的总数，尽量少。



## 稳定性指标 1.定义及解释
  * 最短稳定时间：系统按照最大容量的80%或标准压力（系统的预期日常压力）情况下运行，能够稳定运行的最短时间。 一般来说，对于正常工作日（8小时）运行的系统，至少应该能保证系统稳定运行８小时以上。对于7×24运行的系统，至少应该能够保证系统稳定运行24小时以上。 如果系统不能稳定的运行，上线后，随着业务量的增长和长时间运行，将会出现性能下降甚至崩溃的风险。
  * #### 标准
    * TPS曲线稳定，没有大幅度的波动。
    * 各项资源指标没有泄露或异常情况。


## 稳定性指标 2.批量处理指标
  * 指批量处理程序单位时间内处理的数据数量。一般用每秒处理的数据量来衡量。处理效率是估算批量处理时间窗口最重要的计算指标。 关于批量处理时间窗口，不同系统的批量处理时间窗口在起止时间上可以部分重叠。另外，同一系统内部，也可能存在多个批量处理过程同时进行，其时间窗口相互叠加。 长时间批量处理将会对联机在线实时交易产生重大的性能影响。
  * #### 标准
    * 在数据量很大的情况下，批处理时间窗口时间越短越好。
    * 不能影响实时交易系统性能


## 可扩展性指标
  * #### 标准
    * 理想的扩展能力是资源增加几倍，性能就提升几倍。
    * 扩展能力至少在70%以上。


## 可靠性指标 
  * ## 1.双机热备
    * 节点切换是否成功及其消耗时间。
    * 双机切换是否有业务中断。
    * 节点回切是否成功及其耗时
    * 双机回切是否有业务中断。
    * 节点回切过程中的数据丢失量。在进行双机切换的同时，使用压力发生工具模拟实际业务发生情况，对应用保持一定的性能压力，保证测试结果符合生产实际情况。
  * ## 2.集群
    * 集群中某个节点出现故障时，系统是否有业务中断情况出现。
    * 在集群中新增一个节点时，是否需要重启系统。
    * 当故障节点恢复后，加入集群，是否需要重启系统。
    * 当故障节点恢复后，加入集群，系统是否有业务中断情况出现。
    * 节点切换需要多长时间。在验证集群可靠性的同时，需根据具体情况使用压力工具模拟实际业务发生相关情况，对应用保持一定的性能压力，确保测试结果符合生产实际情况。
  * ## 3.备份和恢复
    * 备份是否成功及其消耗时间。
    * 备份是否使用脚本自动化完成。
    * 恢复是否成功及其消耗时间。
    * 恢复是否使用脚本自动化完成指标体系的运用原则。
    * 指标项的采用和考察取决于对相应系统的测试目的和测试需求。被测系统不一样，测试目的不一样，测试需求也不一样，考察的指标项也有很大差别。
    * 部分系统涉及额外的前端用户接入能力的，需要考察用户接入并发能力指标。
    * 对于批量处理过程的性能验证，主要考虑批量处理效率并估算批量处理时间窗口。
    * 如测试目标涉及到系统性能容量，测试需求中应根据相关指标项的定义，明确描述性能指标需求。
    * 测试指标获取后，需说明相关的前提条件（如在多少的业务量、系统资源情况等）。





[参考](https://www.leoheng.com/2021/06/25/%E5%B8%B8%E7%94%A8%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93/)




